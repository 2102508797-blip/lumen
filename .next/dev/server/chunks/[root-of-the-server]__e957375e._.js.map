{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 166, "column": 0}, "map": {"version":3,"sources":["file:///Users/abey_aryan/Downloads/smart-calendar-app/app/api/chat/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\nimport { GoogleGenAI } from \"@google/genai\"\n\nconst SYSTEM_PROMPT = `You are a helpful AI productivity assistant integrated into a smart calendar app. Your role is to:\n- Provide personalized productivity advice\n- Help users with time management strategies\n- Give tips on effective time blocking and scheduling\n- Suggest productivity techniques and best practices\n- Help users analyze their schedule and habits\n- Motivate users to stay focused and productive\n\nBe conversational, supportive, and practical. Keep responses concise but informative. Focus on actionable advice that users can immediately implement.`\n\nexport async function POST(request: NextRequest) {\n  try {\n    const { message, conversationHistory } = await request.json()\n\n    if (!message || typeof message !== \"string\") {\n      return NextResponse.json(\n        { error: \"Invalid message\" },\n        { status: 400 }\n      )\n    }\n\n    // Determine which provider to use: Gemini (Google) or OpenAI.\n    const useGemini = String(process.env.USE_GEMINI ?? \"false\").toLowerCase() === \"true\"\n    const useOpenAI = String(process.env.USE_OPENAI ?? \"true\").toLowerCase() !== \"false\"\n\n    const geminiKey = process.env.GEMINI_API_KEY\n    const openaiKey = process.env.OPENAI_API_KEY\n\n    // If Gemini is explicitly requested and key present, call Gemini via SDK.\n    if (useGemini && geminiKey) {\n      try {\n        const genAI = new GoogleGenAI({\n          apiKey: geminiKey,\n        })\n\n        // Allow overriding the Gemini model via env var; default to gemini-2-flash\n        const modelName = String(process.env.GEMINI_MODEL ?? \"gemini-2-flash\").trim()\n\n        // Build messages for the Gemini SDK\n        const contents: any[] = []\n\n        // Add conversation history\n        if (conversationHistory && Array.isArray(conversationHistory)) {\n          for (const item of conversationHistory) {\n            contents.push({\n              role: item.role === \"assistant\" ? \"model\" : \"user\",\n              parts: [{ text: item.content }],\n            })\n          }\n        }\n\n        // Add current user message\n        contents.push({\n          role: \"user\",\n          parts: [{ text: message }],\n        })\n\n        const response = await genAI.models.generateContent({\n          model: modelName,\n          contents,\n        })\n\n        // Extract text from response - response.candidates[0].content.parts[0].text\n        const text =\n          response?.candidates?.[0]?.content?.parts?.[0]?.text ||\n          response?.text ||\n          null\n\n        if (text) {\n          return NextResponse.json({ response: text })\n        }\n\n        // If no text returned, fall back to mock\n        return NextResponse.json({\n          response: generateMockResponse(message),\n          warning: \"Gemini returned no text\",\n        })\n      } catch (error: any) {\n        const errorMsg = error?.message || String(error)\n        console.error(\"Gemini SDK error:\", errorMsg)\n\n        // Check for quota/resource exhaustion\n        if (/quota|exceed|resource.*exhaust/i.test(errorMsg)) {\n          return NextResponse.json(\n            {\n              error: \"insufficient_quota\",\n              message:\n                \"Gemini (Google) quota exceeded or resource exhausted. Please check your Google Cloud billing and quotas or set USE_GEMINI=false to use a different provider or mock responses.\",\n            },\n            { status: 402 },\n          )\n        }\n\n        // Check for model not found or invalid key\n        if (/not found|invalid|authentication|permission|denied/i.test(errorMsg)) {\n          return NextResponse.json(\n            {\n              error: \"gemini_auth_or_model_error\",\n              message: `Gemini error: ${errorMsg}. Verify your GEMINI_API_KEY is valid, the model exists, and the Generative Language API is enabled in your Google Cloud project.`,\n            },\n            { status: 403 },\n          )\n        }\n\n        // Other errors: fall back to mock with warning\n        return NextResponse.json({\n          response: generateMockResponse(message),\n          warning: `Gemini error: ${errorMsg}`,\n        })\n      }\n    }\n\n    // If OpenAI is enabled and key present, use OpenAI next\n    if (!useOpenAI || !openaiKey) {\n      // Return a mock response if no provider is available or OpenAI disabled\n      return NextResponse.json({ response: generateMockResponse(message) })\n    }\n\n    // Build messages array for OpenAI\n    const messages = [\n      {\n        role: \"system\",\n        content: SYSTEM_PROMPT,\n      },\n      ...(conversationHistory || []),\n      {\n        role: \"user\",\n        content: message,\n      },\n    ]\n\n    // Call OpenAI API\n    const response = await fetch(\"https://api.openai.com/v1/chat/completions\", {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n        Authorization: `Bearer ${openaiKey}`,\n      },\n      body: JSON.stringify({\n        model: \"gpt-3.5-turbo\",\n        messages: messages,\n        temperature: 0.7,\n        max_tokens: 500,\n      }),\n    })\n\n    if (!response.ok) {\n      // Try to parse the error body from OpenAI to provide helpful feedback\n      let errorBody: any = null\n      try {\n        errorBody = await response.json()\n      } catch (e) {\n        // ignore\n      }\n      console.error(\"OpenAI API error:\", errorBody)\n\n      const openaiErrorCode = errorBody?.error?.code || errorBody?.error?.type || null\n      // If the error indicates insufficient quota, return a clear error payload\n      if (openaiErrorCode === \"insufficient_quota\" || openaiErrorCode === \"insufficient_quota\") {\n        return NextResponse.json(\n          {\n            error: \"insufficient_quota\",\n            message:\n              \"OpenAI quota exceeded. Please check your OpenAI billing and plan at https://platform.openai.com/account/usage or set USE_OPENAI=false to use mock responses.\",\n          },\n          { status: 402 },\n        )\n      }\n\n      // For other errors, fall back to the mock response but include error info\n      return NextResponse.json({\n        response: generateMockResponse(message),\n        warning: errorBody?.error?.message || \"OpenAI API returned an error, using fallback response\",\n      })\n    }\n\n    const data = await response.json()\n    const assistantMessage = data.choices?.[0]?.message?.content || \"I couldn't generate a response.\"\n\n    return NextResponse.json({ response: assistantMessage })\n  } catch (error) {\n    console.error(\"Chat API error:\", error)\n    return NextResponse.json(\n      { error: \"Internal server error\" },\n      { status: 500 }\n    )\n  }\n}\n\n// Mock response generator for when API key is not configured\nfunction generateMockResponse(userMessage: string): string {\n  const lowerMessage = userMessage.toLowerCase()\n\n  // Time blocking tips\n  if (lowerMessage.includes(\"time block\") || lowerMessage.includes(\"schedule\")) {\n    return \"Great question about time blocking! Here are some tips:\\n\\nâœ“ Block 90 minutes for deep work sessions - this is the optimal duration for focused work\\nâœ“ Include buffer time (15-30 minutes) between meetings or classes\\nâœ“ Schedule breaks every 2 hours - even 5-10 minutes helps maintain productivity\\nâœ“ Batch similar tasks together to reduce context switching\\nâœ“ Be realistic about how long tasks actually take\\nâœ“ Protect your deep work blocks - they're precious!\"\n  }\n\n  // Productivity advice\n  if (lowerMessage.includes(\"productivity\") || lowerMessage.includes(\"focus\")) {\n    return \"Here are some proven productivity strategies:\\n\\nðŸŽ¯ Pomodoro Technique: Work for 25 minutes, then take a 5-minute break\\nðŸŽ¯ Energy Management: Schedule high-priority tasks during your peak energy hours\\nðŸŽ¯ Single-tasking: One task at a time is more effective than multitasking\\nðŸŽ¯ Remove distractions: Turn off notifications during focused work\\nðŸŽ¯ Track your progress: Seeing progress is motivating!\\n\\nWhat specific area would you like help with?\"\n  }\n\n  // Stress/overwhelm\n  if (lowerMessage.includes(\"overwhelm\") || lowerMessage.includes(\"stress\") || lowerMessage.includes(\"busy\")) {\n    return \"Feeling overwhelmed is common! Here's how to manage it:\\n\\n1. List everything on your mind - get it out of your head\\n2. Prioritize ruthlessly - focus on what truly matters\\n3. Break large projects into smaller, manageable tasks\\n4. Say no to non-essential commitments\\n5. Schedule breaks and downtime - rest is productive\\n6. Celebrate small wins - progress builds momentum\\n\\nRemember: You can't do everything. Focus on what matters most!\"\n  }\n\n  // Default response\n  return \"That's a great question! Here are some thoughts:\\n\\nâ€¢ Start by identifying your most important tasks\\nâ€¢ Block time for deep, focused work on these priorities\\nâ€¢ Use your calendar to visualize your time and spot patterns\\nâ€¢ Track which activities are actually productive for you\\nâ€¢ Adjust your schedule based on what works best\\n\\nWhat specific productivity challenge are you facing? I'm here to help!\"\n}\n"],"names":[],"mappings":"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"}}]
}